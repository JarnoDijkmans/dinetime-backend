name: CI/CD Pipeline with SonarCloud

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: read


jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matchmaker_changed: ${{ steps.filter.outputs.matchmaker }}
      ranking_changed: ${{ steps.filter.outputs.ranking }}
      realtime_changed: ${{ steps.filter.outputs.realtime }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - uses: actions/checkout@v3

      - name: Detect changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          base: ${{ github.event.before }}
          ref: ${{ github.sha }}
          filters: |
            matchmaker:
              - 'services/matchmaker-service/**'
            ranking:
              - 'services/ranking-service/**'
            realtime:
              - 'services/realtime-service/**'
            ci:
              - '.github/workflows/**'
              - 'ci-cd.yml'
              - '*.md'

  run-tests-and-analysis:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.matchmaker_changed == 'true' || 
        needs.detect-changes.outputs.ranking_changed == 'true' || 
        needs.detect-changes.outputs.realtime_changed == 'true'
    steps:
      - uses: actions/checkout@v3

      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle

      - name: Cache Node modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Cache Dependency-Check Data
        uses: actions/cache@v4
        with:
          path: ~/.dependency-check
          key: owasp-dc-data-${{ runner.os }}



      # Matchmaker Tests + Sonar + Dependency Check
      - name: Run Matchmaker Tests
        if: needs.detect-changes.outputs.matchmaker_changed == 'true'
        run: ./gradlew clean test jacocoTestReport -Dspring.profiles.active=test
        working-directory: services/matchmaker-service

      - name: Analyze Matchmaker with SonarCloud
        if: needs.detect-changes.outputs.matchmaker_changed == 'true'
        run: ./gradlew sonarqube -Dsonar.login=${{ secrets.SONAR_TOKEN }}
        working-directory: services/matchmaker-service

      - name: Install OWASP Dependency-Check
        run: |
          wget https://github.com/jeremylong/DependencyCheck/releases/download/v9.0.9/dependency-check-9.0.9-release.zip
          unzip dependency-check-9.0.9-release.zip -d dependency-check
      
      - name: Dependency-Check (Matchmaker)
        if: needs.detect-changes.outputs.matchmaker_changed == 'true'
        run: |
          ./dependency-check/bin/dependency-check.sh \
            --project "matchmaker-service" \
            --scan services/matchmaker-service \
            --format HTML \
            --out services/matchmaker-service/build/reports/dependency-check \
            --failOnCVSS 7 \
            --nvdApiKey "${{ secrets.NVD_API_KEY }}"


      # Ranking Tests + Sonar + Dependency Check
      - name: Run Ranking Tests and Coverage
        if: needs.detect-changes.outputs.ranking_changed == 'true'
        run: ./gradlew clean test jacocoTestReport -Dspring.profiles.active=test
        working-directory: services/ranking-service

      - name: Analyze Ranking with SonarCloud
        if: needs.detect-changes.outputs.ranking_changed == 'true'
        run: ./gradlew sonarqube -Dsonar.login=${{ secrets.SONAR_TOKEN }}
        working-directory: services/ranking-service

      - name: Dependency-Check (Ranking)
        if: needs.detect-changes.outputs.ranking_changed == 'true'
        run: |
          ./dependency-check/bin/dependency-check.sh \
            --project "ranking-service" \
            --scan services/ranking-service \
            --format HTML \
            --out services/ranking-service/build/reports/dependency-check \
            --failOnCVSS 7 \
            --nvdApiKey "${{ secrets.NVD_API_KEY }}"

      # Realtime Tests + Sonar + Dependency Check
      - name: Run Realtime Tests
        if: needs.detect-changes.outputs.realtime_changed == 'true'
        run: |
          npm ci
          npm test
        working-directory: services/realtime-service

      - name: Analyze Realtime with SonarCloud
        uses: SonarSource/sonarcloud-github-action@v2.2
        with:
          projectBaseDir: services/realtime-service
          args: >
            -Dsonar.organization=dinetime-sonar
            -Dsonar.projectKey=dinetime-sonar_realtime-service
            -Dsonar.host.url=https://sonarcloud.io
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Security Audit (Realtime)
        if: needs.detect-changes.outputs.realtime_changed == 'true'
        run: |
          npm ci
          npm audit --audit-level=moderate --production
        working-directory: services/realtime-service

      - name: Upload Dependency-Check Report (Matchmaker)
        if: needs.detect-changes.outputs.matchmaker_changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report-matchmaker
          path: services/matchmaker-service/build/reports/dependency-check

      - name: Upload Dependency-Check Report (Ranking)
        if: needs.detect-changes.outputs.ranking_changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report-ranking
          path: services/ranking-service/build/reports/dependency-check

      - name: Upload npm Audit Report (Realtime)
        if: needs.detect-changes.outputs.realtime_changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report-realtime
          path: services/realtime-service/audit-report.json


  build-and-deploy:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Login
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build Java Services
        run: |
          cd services/matchmaker-service && ./gradlew bootJar && cd ../..
          cd services/ranking-service && ./gradlew bootJar && cd ../..

      - name: Build Realtime Service (Node.js)
        run: |
          cd services/realtime-service
          npm ci
          npm run build || echo "No build script defined; skipping..."
          cd ../..
      
      - name: Build All Services
        run: docker compose build

      - name: Push Matchmaker Image
        run: |
          docker tag dinetime-backend-matchmaker-service dockerjarnodijkmans/matchmaker-service:${{ github.sha }}
          docker tag dinetime-backend-matchmaker-service dockerjarnodijkmans/matchmaker-service:latest

          docker push dockerjarnodijkmans/matchmaker-service:${{ github.sha }}
          docker push dockerjarnodijkmans/matchmaker-service:latest


      - name: Push Ranking Image
        run: |
          docker tag dinetime-backend-ranking-service dockerjarnodijkmans/ranking-service:${{ github.sha }}
          docker tag dinetime-backend-ranking-service dockerjarnodijkmans/ranking-service:latest

          docker push dockerjarnodijkmans/ranking-service:${{ github.sha }}
          docker push dockerjarnodijkmans/ranking-service:latest


      - name: Push Realtime Image
        run: |
          docker tag dinetime-backend-realtime-service dockerjarnodijkmans/realtime-service:${{ github.sha }}
          docker tag dinetime-backend-realtime-service dockerjarnodijkmans/realtime-service:latest
          
          docker push dockerjarnodijkmans/realtime-service:${{ github.sha }}
          docker push dockerjarnodijkmans/realtime-service:latest

